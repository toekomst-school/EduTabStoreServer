services:
  fdroid:
    build: .
    container_name: edutabstore-fdroid
    volumes:
      - ./data/repo:/repo
      - ./data/config:/config
      - ./data/unsigned:/unsigned
    environment:
      - KEYSTOREPASS=${KEYSTOREPASS:-android}
      - ANDROID_HOME=/opt/android-sdk

  nginx:
    image: nginx:alpine
    container_name: edutabstore-nginx
    ports:
      - "8080:80"
      - "8443:443"
    volumes:
      - ./data/repo/repo:/usr/share/nginx/html/repo:ro
      - ./data/repo/archive:/usr/share/nginx/html/archive:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # Uncomment for SSL:
      # - ./ssl/fullchain.pem:/etc/nginx/ssl/fullchain.pem:ro
      # - ./ssl/privkey.pem:/etc/nginx/ssl/privkey.pem:ro
    restart: unless-stopped

  # Optional: Auto-update on schedule
  updater:
    build: .
    container_name: edutabstore-updater
    volumes:
      - ./data/repo:/repo
      - ./data/config:/config
      - ./data/unsigned:/unsigned
    environment:
      - KEYSTOREPASS=${KEYSTOREPASS:-android}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        while true; do
          echo "[$(date)] Checking for new APKs..."
          if [ "$$(ls -A /unsigned/*.apk 2>/dev/null)" ]; then
            echo "[$(date)] Found new APKs, updating repository..."
            cd /repo && fdroid update --create-metadata
            rm -f /unsigned/*.apk
            echo "[$(date)] Repository updated!"
          fi
          sleep 300  # Check every 5 minutes
        done
    restart: unless-stopped
    profiles:
      - auto-update
